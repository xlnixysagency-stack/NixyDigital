<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz ‚Äî Study Buddy AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
          --black: #020202;
          --evergreen: #0d2818;
          --forest: #04471c;
          --seagreen: #058c42;
          --malachite: #16db65;
          --text: #e8f5ee;
          --muted: #7aad8f;
          --card: rgba(13,40,24,0.7);
          --border: rgba(22,219,101,0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
          background: var(--black);
          color: var(--text);
          font-family: 'DM Sans', sans-serif;
          min-height: 100vh;
          overflow-x: hidden;
        }

        /* Ambient background */
        body::before {
          content: '';
          position: fixed;
          top: -40%;
          left: -20%;
          width: 700px;
          height: 700px;
          background: radial-gradient(circle, rgba(5,140,66,0.06) 0%, transparent 70%);
          pointer-events: none;
          z-index: 0;
        }

        /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
        #loadingScreen {
          position: fixed; inset: 0;
          background: var(--black);
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          z-index: 100;
          gap: 16px;
        }
        .loader-ring {
          width: 48px; height: 48px;
          border: 3px solid var(--border);
          border-top-color: var(--malachite);
          border-radius: 50%;
          animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loadingScreen p { color: var(--muted); font-size: 14px; }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .page { display: none; min-height: 100vh; padding: 40px 20px; position: relative; z-index: 1; }
        .page.active { display: flex; flex-direction: column; align-items: center; }

        /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
        .topbar {
          width: 100%; max-width: 720px;
          display: flex; align-items: center; justify-content: space-between;
          margin-bottom: 48px;
        }
        .logo { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; letter-spacing: 0.08em; }
        .logo span { color: var(--malachite); }
        .back-btn {
          display: flex; align-items: center; gap: 8px;
          background: none; border: 1px solid var(--border);
          color: var(--muted); border-radius: 8px;
          padding: 8px 14px; font-size: 13px;
          cursor: pointer; font-family: 'DM Sans', sans-serif;
          transition: all 0.2s;
        }
        .back-btn:hover { border-color: var(--malachite); color: var(--malachite); }

        /* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
        .progress-wrap {
          width: 100%; max-width: 720px;
          margin-bottom: 32px;
        }
        .progress-meta {
          display: flex; justify-content: space-between;
          font-size: 12px; color: var(--muted); margin-bottom: 10px;
          font-weight: 500; letter-spacing: 0.04em;
        }
        .progress-track {
          height: 4px;
          background: var(--border);
          border-radius: 99px;
          overflow: hidden;
        }
        .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--seagreen), var(--malachite));
          border-radius: 99px;
          transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
        }

        /* ‚îÄ‚îÄ Question card ‚îÄ‚îÄ */
        .q-card {
          width: 100%; max-width: 720px;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 20px;
          padding: 36px;
          backdrop-filter: blur(12px);
          position: relative;
          overflow: hidden;
        }
        .q-card::before {
          content: '';
          position: absolute; top: 0; left: 0; right: 0;
          height: 2px;
          background: linear-gradient(90deg, var(--seagreen), var(--malachite), transparent);
        }
        .q-number {
          font-size: 11px; font-weight: 600;
          color: var(--malachite); letter-spacing: 0.1em;
          text-transform: uppercase; margin-bottom: 16px;
        }
        .q-text {
          font-family: 'Syne', sans-serif;
          font-size: 20px; font-weight: 600;
          line-height: 1.45;
          color: var(--text);
          margin-bottom: 28px;
        }

        /* ‚îÄ‚îÄ Answer input ‚îÄ‚îÄ */
        .answer-label {
          font-size: 11px; font-weight: 600;
          color: var(--muted); letter-spacing: 0.08em;
          text-transform: uppercase; margin-bottom: 10px;
          display: block;
        }
        .answer-input {
          width: 100%;
          background: rgba(4,71,28,0.3);
          border: 1px solid var(--border);
          border-radius: 12px;
          padding: 14px 16px;
          color: var(--text);
          font-family: 'DM Sans', sans-serif;
          font-size: 15px;
          resize: none;
          min-height: 64px;
          max-height: 120px;
          transition: border-color 0.2s, background 0.2s;
          outline: none;
          line-height: 1.5;
        }
        .answer-input:focus { border-color: var(--seagreen); background: rgba(4,71,28,0.5); }
        .answer-input:disabled { opacity: 0.7; cursor: not-allowed; }

        /* ‚îÄ‚îÄ Check button ‚îÄ‚îÄ */
        .check-btn {
          margin-top: 20px;
          width: 100%;
          padding: 15px;
          background: linear-gradient(135deg, var(--forest), var(--seagreen));
          border: none; border-radius: 12px;
          color: #fff; font-family: 'Syne', sans-serif;
          font-size: 15px; font-weight: 700;
          cursor: pointer;
          transition: all 0.2s;
          letter-spacing: 0.04em;
          position: relative;
          overflow: hidden;
        }
        .check-btn:hover:not(:disabled) {
          transform: translateY(-1px);
          box-shadow: 0 8px 24px rgba(5,140,66,0.3);
        }
        .check-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .check-btn.checking {
          background: linear-gradient(135deg, var(--evergreen), var(--forest));
        }

        /* ‚îÄ‚îÄ AI Feedback box ‚îÄ‚îÄ */
        .feedback-box {
          margin-top: 20px;
          padding: 18px 20px;
          border-radius: 12px;
          font-size: 14px;
          line-height: 1.6;
          display: none;
          animation: slideIn 0.3s ease;
          position: relative;
        }
        @keyframes slideIn {
          from { opacity: 0; transform: translateY(-8px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .feedback-box.correct {
          background: rgba(22,219,101,0.08);
          border: 1px solid rgba(22,219,101,0.25);
        }
        .feedback-box.incorrect {
          background: rgba(244,68,46,0.06);
          border: 1px solid rgba(244,68,46,0.2);
        }
        .feedback-box.partial {
          background: rgba(188,95,4,0.08);
          border: 1px solid rgba(188,95,4,0.25);
        }
        .feedback-header {
          display: flex; align-items: center; gap: 8px;
          font-family: 'Syne', sans-serif;
          font-weight: 700; font-size: 13px;
          margin-bottom: 8px;
        }
        .feedback-icon { font-size: 16px; }
        .feedback-correct .feedback-header { color: var(--malachite); }
        .feedback-incorrect .feedback-header { color: #f4442e; }
        .feedback-partial .feedback-header { color: #bc5f04; }
        .feedback-explanation { color: var(--muted); font-size: 13px; }

        /* ‚îÄ‚îÄ Next button ‚îÄ‚îÄ */
        .next-btn {
          margin-top: 16px;
          width: 100%;
          padding: 14px;
          background: none;
          border: 1px solid var(--border);
          border-radius: 12px;
          color: var(--text);
          font-family: 'DM Sans', sans-serif;
          font-size: 14px; font-weight: 500;
          cursor: pointer;
          transition: all 0.2s;
          display: none;
        }
        .next-btn:hover {
          border-color: var(--malachite);
          color: var(--malachite);
          background: rgba(22,219,101,0.05);
        }

        /* ‚îÄ‚îÄ Score tracker ‚îÄ‚îÄ */
        .score-strip {
          width: 100%; max-width: 720px;
          display: flex; gap: 12px;
          margin-bottom: 24px;
        }
        .score-pill {
          flex: 1; padding: 12px;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 12px;
          text-align: center;
        }
        .score-pill .val {
          font-family: 'Syne', sans-serif;
          font-size: 24px; font-weight: 800;
        }
        .score-pill .lbl {
          font-size: 11px; color: var(--muted);
          text-transform: uppercase; letter-spacing: 0.06em;
          margin-top: 2px;
        }
        .score-pill.correct .val { color: var(--malachite); }
        .score-pill.incorrect .val { color: #f4442e; }
        .score-pill.remaining .val { color: var(--text); }

        /* ‚îÄ‚îÄ Results page ‚îÄ‚îÄ */
        #resultsPage {
          gap: 0;
        }
        .results-hero {
          width: 100%; max-width: 720px;
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 20px;
          padding: 48px 36px;
          text-align: center;
          position: relative;
          overflow: hidden;
          margin-bottom: 24px;
        }
        .results-hero::before {
          content: '';
          position: absolute; top: 0; left: 0; right: 0; height: 2px;
          background: linear-gradient(90deg, transparent, var(--malachite), transparent);
        }
        .results-grade {
          font-family: 'Syne', sans-serif;
          font-size: 80px; font-weight: 800;
          line-height: 1;
          background: linear-gradient(135deg, var(--seagreen), var(--malachite));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: 8px;
        }
        .results-label {
          font-size: 14px; color: var(--muted);
          margin-bottom: 24px;
        }
        .results-message {
          font-family: 'Syne', sans-serif;
          font-size: 22px; font-weight: 700;
          color: var(--text);
          margin-bottom: 8px;
        }
        .results-sub { font-size: 14px; color: var(--muted); }
        .results-grid {
          width: 100%; max-width: 720px;
          display: grid; grid-template-columns: 1fr 1fr 1fr;
          gap: 12px; margin-bottom: 24px;
        }
        .result-stat {
          background: var(--card);
          border: 1px solid var(--border);
          border-radius: 14px;
          padding: 20px; text-align: center;
        }
        .result-stat .num {
          font-family: 'Syne', sans-serif;
          font-size: 28px; font-weight: 800;
          color: var(--malachite);
        }
        .result-stat .desc { font-size: 12px; color: var(--muted); margin-top: 4px; }
        .results-actions {
          width: 100%; max-width: 720px;
          display: flex; gap: 12px;
        }
        .btn-primary, .btn-secondary {
          flex: 1; padding: 15px;
          border-radius: 12px;
          font-family: 'Syne', sans-serif;
          font-size: 14px; font-weight: 700;
          cursor: pointer; transition: all 0.2s;
          letter-spacing: 0.03em;
        }
        .btn-primary {
          background: linear-gradient(135deg, var(--forest), var(--seagreen));
          border: none; color: #fff;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(5,140,66,0.3); }
        .btn-secondary {
          background: none;
          border: 1px solid var(--border);
          color: var(--text);
        }
        .btn-secondary:hover { border-color: var(--malachite); color: var(--malachite); }

        /* ‚îÄ‚îÄ Checking overlay ‚îÄ‚îÄ */
        .checking-indicator {
          display: flex; align-items: center; gap: 10px;
          color: var(--muted); font-size: 13px;
          margin-top: 12px;
          display: none;
        }
        .checking-dot {
          width: 6px; height: 6px; border-radius: 50%;
          background: var(--malachite);
          animation: pulse 1s ease-in-out infinite;
        }
        .checking-dot:nth-child(2) { animation-delay: 0.2s; }
        .checking-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }

        .no-quiz-msg {
          text-align: center;
          padding: 80px 20px;
        }
        .no-quiz-msg h2 {
          font-family: 'Syne', sans-serif;
          font-size: 24px; font-weight: 700;
          margin-bottom: 12px;
        }
        .no-quiz-msg p { color: var(--muted); font-size: 14px; margin-bottom: 24px; }
    </style>
</head>
<body>

<!-- Loading -->
<div id="loadingScreen">
    <div class="loader-ring"></div>
    <p>Loading quiz...</p>
</div>

<!-- Quiz page -->
<div id="quizPage" class="page">
    <div class="topbar">
        <div class="logo">NIXY<span>DIGITAL</span></div>
        <button class="back-btn" onclick="window.location.href='dashboard.html'">
            ‚Üê Dashboard
        </button>
    </div>

    <!-- Score strip -->
    <div class="score-strip">
        <div class="score-pill correct">
            <div class="val" id="correctCount">0</div>
            <div class="lbl">Correct</div>
        </div>
        <div class="score-pill incorrect">
            <div class="val" id="incorrectCount">0</div>
            <div class="lbl">Incorrect</div>
        </div>
        <div class="score-pill remaining">
            <div class="val" id="remainingCount">‚Äî</div>
            <div class="lbl">Remaining</div>
        </div>
    </div>

    <!-- Progress -->
    <div class="progress-wrap">
        <div class="progress-meta">
            <span id="progressLabel">Question 1 of 5</span>
            <span id="progressPct">0%</span>
        </div>
        <div class="progress-track">
            <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
    </div>

    <!-- Question card -->
    <div class="q-card">
        <div class="q-number" id="qNumber">QUESTION 1</div>
        <div class="q-text" id="qText">Loading...</div>
        <label class="answer-label">Your answer</label>
        <textarea class="answer-input" id="answerInput"
                  placeholder="Type your answer here... Don't worry about exact wording, just explain what you know."
                  rows="2"></textarea>

        <!-- Checking animation -->
        <div class="checking-indicator" id="checkingIndicator">
            <div class="checking-dot"></div>
            <div class="checking-dot"></div>
            <div class="checking-dot"></div>
            <span>AI is evaluating your answer...</span>
        </div>

        <!-- Check button -->
        <button class="check-btn" id="checkBtn" onclick="checkAnswer()">Check Answer</button>

        <!-- Feedback -->
        <div class="feedback-box" id="feedbackBox">
            <div class="feedback-header">
                <span class="feedback-icon" id="feedbackIcon"></span>
                <span id="feedbackTitle"></span>
            </div>
            <div class="feedback-explanation" id="feedbackExplanation"></div>
        </div>

        <!-- Next -->
        <button class="next-btn" id="nextBtn" onclick="nextQuestion()">
            Next Question ‚Üí
        </button>
    </div>
</div>

<!-- Results page -->
<div id="resultsPage" class="page">
    <div class="topbar">
        <div class="logo">NIXY<span>DIGITAL</span></div>
        <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Dashboard</button>
    </div>

    <div class="results-hero">
        <div class="results-grade" id="resultsGrade">‚Äî%</div>
        <div class="results-label" id="resultsScoreLabel">‚Äî / ‚Äî correct</div>
        <div class="results-message" id="resultsMessage">Quiz Complete!</div>
        <div class="results-sub" id="resultsSub"></div>
    </div>

    <div class="results-grid">
        <div class="result-stat">
            <div class="num" id="resTotalQ">‚Äî</div>
            <div class="desc">Total Questions</div>
        </div>
        <div class="result-stat">
            <div class="num" id="resCorrect">‚Äî</div>
            <div class="desc">Correct</div>
        </div>
        <div class="result-stat">
            <div class="num" id="resAccuracy">‚Äî%</div>
            <div class="desc">Accuracy</div>
        </div>
    </div>

    <div class="results-actions">
        <button class="btn-primary" onclick="retakeQuiz()">Retake Quiz</button>
        <button class="btn-secondary" onclick="window.location.href='dashboard.html'">Dashboard</button>
    </div>
</div>

<!-- Firebase + Logic -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, addDoc, collection, serverTimestamp }
      from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB3ZEv5TgFr8SM1jCLyHJow3N39xfHYZNk",
      authDomain: "studybuddyai-5561d.firebaseapp.com",
      projectId: "studybuddyai-5561d",
      storageBucket: "studybuddyai-5561d.firebasestorage.app",
      messagingSenderId: "559083222865",
      appId: "1:559083222865:web:26b4351fd26330716b4570"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let questions = [];
    let currentIdx = 0;
    let correct = 0;
    let incorrect = 0;
    let answers = [];
    let materialId = null;
    let currentUser = null;
    let GROQ_KEY = localStorage.getItem('groq_key') || '';

    // ‚îÄ‚îÄ Expose to global ‚îÄ‚îÄ
    window.checkAnswer = checkAnswer;
    window.nextQuestion = nextQuestion;
    window.retakeQuiz   = retakeQuiz;

    // ‚îÄ‚îÄ Auth guard ‚îÄ‚îÄ
    onAuthStateChanged(auth, async user => {
      if (!user) { window.location.href = 'auth.html'; return; }
      currentUser = user;

      const params = new URLSearchParams(window.location.search);
      materialId = params.get('id');

      if (!materialId) {
        window.location.href = 'upload.html';
        return;
      }

      await loadQuiz();
    });

    async function loadQuiz() {
      try {
        const snap = await getDoc(doc(db, 'study_materials', materialId));
        if (!snap.exists()) { window.location.href = 'upload.html'; return; }

        const data = snap.data();
        questions = data.questions || [];

        if (!questions.length) {
          window.location.href = `generate-groq.html?id=${materialId}`;
          return;
        }

        // normalise ‚Äî strip "Question X:" prefix if present
        questions = questions.map(q => {
          if (typeof q === 'string') {
            return { question: q.replace(/^question\s*\d+[:.)]\s*/i, ''), answer: '' };
          }
          return q;
        });

        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('quizPage').classList.add('active');
        renderQuestion();
      } catch (e) {
        console.error(e);
        document.getElementById('loadingScreen').innerHTML =
          '<p style="color:#f4442e">Error loading quiz. <a href="dashboard.html" style="color:var(--malachite)">Go back</a></p>';
      }
    }

    function renderQuestion() {
      const q = questions[currentIdx];
      const total = questions.length;

      document.getElementById('qNumber').textContent = `QUESTION ${currentIdx + 1}`;
      document.getElementById('qText').textContent = typeof q === 'string' ? q : q.question;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').disabled = false;
      document.getElementById('checkBtn').disabled = false;
      document.getElementById('checkBtn').textContent = 'Check Answer';
      document.getElementById('checkBtn').classList.remove('checking');
      document.getElementById('feedbackBox').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';
      document.getElementById('checkingIndicator').style.display = 'none';

      // progress
      const pct = Math.round((currentIdx / total) * 100);
      document.getElementById('progressLabel').textContent = `Question ${currentIdx + 1} of ${total}`;
      document.getElementById('progressPct').textContent = `${pct}%`;
      document.getElementById('progressFill').style.width = `${pct}%`;

      // score strip
      document.getElementById('correctCount').textContent = correct;
      document.getElementById('incorrectCount').textContent = incorrect;
      document.getElementById('remainingCount').textContent = total - currentIdx;

      // focus
      setTimeout(() => document.getElementById('answerInput').focus(), 100);
    }

    async function checkAnswer() {
      const input = document.getElementById('answerInput');
      const userAnswer = input.value.trim();
      if (!userAnswer) { input.focus(); return; }

      const q = questions[currentIdx];
      const questionText = typeof q === 'string' ? q : q.question;
      const referenceAnswer = typeof q === 'string' ? '' : (q.answer || '');

      // Show checking state
      document.getElementById('checkBtn').disabled = true;
      document.getElementById('checkBtn').textContent = 'Evaluating...';
      document.getElementById('checkBtn').classList.add('checking');
      document.getElementById('checkingIndicator').style.display = 'flex';
      input.disabled = true;

      try {
        const result = await evaluateWithAI(questionText, referenceAnswer, userAnswer);
        showFeedback(result);
      } catch (e) {
        // Fallback: simple keyword match
        const fallback = simpleFallback(questionText, referenceAnswer, userAnswer);
        showFeedback(fallback);
      }
    }

    async function evaluateWithAI(question, reference, userAnswer) {
      if (!GROQ_KEY) {
        // prompt user once
        const key = prompt('Enter your Groq API key to enable AI grading (or press Cancel for basic grading):');
        if (key) {
          GROQ_KEY = key.trim();
          localStorage.setItem('groq_key', GROQ_KEY);
        } else {
          return simpleFallback(question, reference, userAnswer);
        }
      }

      const prompt = `You are a helpful, encouraging study quiz grader.

    Question: "${question}"
    ${reference ? `Reference answer (use as guidance, not exact match): "${reference}"` : ''}
    Student's answer: "${userAnswer}"

    Evaluate the student's answer and respond in JSON only:
    {
      "verdict": "correct" | "partial" | "incorrect",
      "score": 1 | 0.5 | 0,
      "title": "short encouraging title (max 6 words)",
      "explanation": "1-2 sentences of feedback. If correct, give a fun fact. If wrong, explain the key concept clearly."
    }

    Be generous ‚Äî if the core idea is right, even with different wording, mark correct. Partial credit for half-right answers.`;

      const resp = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${GROQ_KEY}`
        },
        body: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.3,
          max_tokens: 200
        })
      });

      const data = await resp.json();
      const raw = data.choices[0].message.content.trim();
      // strip markdown fences if present
      const clean = raw.replace(/```json|```/g, '').trim();
      return JSON.parse(clean);
    }

    function simpleFallback(question, reference, userAnswer) {
      const ua = userAnswer.toLowerCase();
      const ref = (reference || question).toLowerCase();
      const words = ref.split(/\s+/).filter(w => w.length > 4);
      const matches = words.filter(w => ua.includes(w)).length;
      const ratio = words.length ? matches / words.length : 0;

      if (ratio >= 0.5) return {
        verdict: 'correct', score: 1,
        title: 'Looks good!',
        explanation: 'Your answer covers the key concepts.'
      };
      if (ratio >= 0.25) return {
        verdict: 'partial', score: 0.5,
        title: 'Partially correct',
        explanation: 'You got some of it ‚Äî review the material for the full picture.'
      };
      return {
        verdict: 'incorrect', score: 0,
        title: 'Not quite',
        explanation: 'Review this concept in your notes and try again!'
      };
    }

    function showFeedback(result) {
      document.getElementById('checkingIndicator').style.display = 'none';
      document.getElementById('checkBtn').textContent = 'Check Answer';
      document.getElementById('checkBtn').classList.remove('checking');

      const verdict = result.verdict;
      const box = document.getElementById('feedbackBox');
      const icon = document.getElementById('feedbackIcon');
      const title = document.getElementById('feedbackTitle');
      const expl = document.getElementById('feedbackExplanation');

      box.className = 'feedback-box ' + verdict;
      box.style.display = 'block';

      if (verdict === 'correct') {
        icon.textContent = '‚úì';
        title.style.color = 'var(--malachite)';
        correct++;
      } else if (verdict === 'partial') {
        icon.textContent = '‚óê';
        title.style.color = '#bc5f04';
        correct += 0.5;
      } else {
        icon.textContent = '‚úó';
        title.style.color = '#f4442e';
        incorrect++;
      }

      title.textContent = result.title || 'Done';
      expl.textContent  = result.explanation || '';

      answers.push({ question: questions[currentIdx], userAnswer: document.getElementById('answerInput').value, verdict, score: result.score });

      // Update score strip
      document.getElementById('correctCount').textContent = Math.round(correct);
      document.getElementById('incorrectCount').textContent = incorrect;

      // Show next or finish
      const nextBtn = document.getElementById('nextBtn');
      nextBtn.style.display = 'block';
      if (currentIdx >= questions.length - 1) {
        nextBtn.textContent = 'See Results ‚Üí';
      } else {
        nextBtn.textContent = 'Next Question ‚Üí';
      }
    }

    function nextQuestion() {
      currentIdx++;
      if (currentIdx >= questions.length) {
        showResults();
      } else {
        renderQuestion();
      }
    }

    async function showResults() {
      const total = questions.length;
      const pct = Math.round((correct / total) * 100);

      document.getElementById('quizPage').classList.remove('active');
      document.getElementById('resultsPage').classList.add('active');

      document.getElementById('resultsGrade').textContent = `${pct}%`;
      document.getElementById('resultsScoreLabel').textContent = `${Math.round(correct)} / ${total} correct`;
      document.getElementById('resTotalQ').textContent = total;
      document.getElementById('resCorrect').textContent = Math.round(correct);
      document.getElementById('resAccuracy').textContent = `${pct}%`;

      let msg, sub;
      if (pct >= 90) { msg = 'üèÜ Exceptional!'; sub = 'You nailed it. You clearly know this material.'; }
      else if (pct >= 75) { msg = 'üéâ Great Work!'; sub = 'Solid performance. A little review and you\'ll be perfect.'; }
      else if (pct >= 60) { msg = 'üëç Good effort'; sub = 'You\'re getting there. Focus on the ones you missed.'; }
      else { msg = 'üìö Keep studying'; sub = 'Review the material and try again ‚Äî you\'ve got this!'; }

      document.getElementById('resultsMessage').textContent = msg;
      document.getElementById('resultsSub').textContent = sub;

      // Save to Firebase
      try {
        await addDoc(collection(db, 'quiz_results'), {
          userId: currentUser.uid,
          userEmail: currentUser.email,
          materialId,
          totalQuestions: total,
          correctAnswers: Math.round(correct),
          accuracy: pct,
          answers,
          completedAt: serverTimestamp()
        });
      } catch (e) { console.error('Save error:', e); }
    }

    function retakeQuiz() {
      currentIdx = 0; correct = 0; incorrect = 0; answers = [];
      document.getElementById('resultsPage').classList.remove('active');
      document.getElementById('quizPage').classList.add('active');
      renderQuestion();
    }

    // Enter key submits
    document.getElementById('answerInput').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!document.getElementById('checkBtn').disabled) checkAnswer();
      }
    });
</script>
</body>
</html>